# =============================================================================
# aitema|Hinweis - Nginx Security Headers Configuration
# BSI IT-Grundschutz APP.3.2 / SYS.1.1 / OPS.1.1.4 compliant
# =============================================================================

# --- HSTS (HTTP Strict Transport Security) ---
# BSI APP.3.2.A11: Enforce HTTPS for all connections
# max-age=63072000 = 2 years, includeSubDomains for all subdomains
add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

# --- Content-Security-Policy (CSP) ---
# BSI APP.3.2.A14: Restrict resource loading origins
# Whistleblowing platform: strict policy, no inline scripts
add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self'; connect-src 'self' wss:; frame-ancestors 'none'; base-uri 'self'; form-action 'self'; object-src 'none'; media-src 'none'; worker-src 'self' blob:; manifest-src 'self'; upgrade-insecure-requests" always;

# --- X-Frame-Options ---
# BSI APP.3.2.A14: Prevent clickjacking attacks
# DENY = page cannot be displayed in a frame regardless of origin
add_header X-Frame-Options "DENY" always;

# --- X-Content-Type-Options ---
# BSI APP.3.2.A14: Prevent MIME-type sniffing
add_header X-Content-Type-Options "nosniff" always;

# --- Referrer-Policy ---
# BSI APP.3.2.A14: Control referrer information leakage
# strict-origin-when-cross-origin: full path for same-origin, origin-only for cross-origin HTTPS
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# --- Permissions-Policy ---
# BSI APP.3.2.A14: Disable unnecessary browser features
# Whistleblowing system: no camera, microphone, geolocation, payment needed
add_header Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=(), autoplay=(), encrypted-media=(), picture-in-picture=(), fullscreen=(self), display-capture=()" always;

# --- X-XSS-Protection ---
# Legacy header for older browsers (CSP supersedes this)
add_header X-XSS-Protection "1; mode=block" always;

# --- Cross-Origin Headers ---
# Prevent cross-origin information leaks
add_header Cross-Origin-Embedder-Policy "require-corp" always;
add_header Cross-Origin-Opener-Policy "same-origin" always;
add_header Cross-Origin-Resource-Policy "same-origin" always;

# --- Cache-Control for sensitive pages ---
# BSI APP.3.2.A11: Prevent caching of sensitive data
add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
add_header Pragma "no-cache" always;

# --- Server Information Hiding ---
# BSI SYS.1.1.A8: Minimize information disclosure
server_tokens off;

# --- SSL/TLS Configuration ---
# BSI TR-02102-2: TLS configuration requirements
# Only TLS 1.2 and 1.3 allowed per BSI recommendation
ssl_protocols TLSv1.2 TLSv1.3;

# BSI TR-02102-2: Cipher suite configuration
# Server-side cipher preference, forward secrecy mandatory
ssl_prefer_server_ciphers on;
ssl_ciphers "ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256";

# ECDH curve configuration per BSI TR-02102-2
ssl_ecdh_curve secp384r1:secp256r1;

# SSL session configuration
ssl_session_timeout 1d;
ssl_session_cache shared:SSL:10m;
ssl_session_tickets off;

# OCSP Stapling for certificate validation
ssl_stapling on;
ssl_stapling_verify on;

# --- Buffer Overflow Protection ---
# Limit buffer sizes to prevent overflow attacks
client_body_buffer_size 16k;
client_header_buffer_size 1k;
large_client_header_buffers 4 8k;

# --- Timeout Configuration ---
# BSI OPS.1.1.4: Prevent slow-loris and timeout attacks
client_body_timeout 12;
client_header_timeout 12;
send_timeout 10;

# --- Request Size Limits ---
# Limit upload size (whistleblowing attachments)
client_max_body_size 50M;

# --- Logging for Security Monitoring ---
# BSI OPS.1.1.5: Security event logging
log_format security '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent" '
                    '$request_time $upstream_response_time '
                    '$ssl_protocol $ssl_cipher '
                    'req_id=$request_id';

# --- GeoIP / IP Restriction for Admin Panel ---
# BSI OPS.1.1.4: Admin access restriction
# Uncomment and configure for production admin IP restrictions
# geo $admin_access {
#     default       0;
#     10.0.0.0/8    1;  # Internal networks
#     172.16.0.0/12 1;  # Internal networks
#     192.168.0.0/16 1; # Internal networks
# }
