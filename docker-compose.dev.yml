# aitema|Hinweis - HinSchG-konformes Hinweisgebersystem
# Development Environment
# Based on GlobaLeaks Fork with HinSchG Extensions

version: "3.9"

services:
  # ============================================================
  # Backend (GlobaLeaks Fork + HinSchG Extensions)
  # ============================================================
  backend:
    build:
      context: .
      dockerfile: docker/Dockerfile.dev
    container_name: aitema-hinweis-backend
    volumes:
      - ./backend:/app/backend
      - gl-data:/var/globaleaks
      - ./backend/globaleaks:/usr/lib/python3/dist-packages/globaleaks
    ports:
      - "8082:8080"
      - "8444:8443"
    environment:
      - GLOBALEAKS_WORKING_PATH=/var/globaleaks
      - GLOBALEAKS_DEV_MODE=true
      - DATABASE_URI=sqlite:///var/globaleaks/globaleaks.db
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - aitema-hinweis

  # ============================================================
  # Frontend (Angular 17+)
  # ============================================================
  frontend:
    build:
      context: ./client
      dockerfile: Dockerfile.dev
    container_name: aitema-hinweis-frontend
    volumes:
      - ./client/app:/app/app
      - ./client/cypress:/app/cypress
      - /app/node_modules
    ports:
      - "4200:4200"
    environment:
      - API_URL=http://backend:8080
      - NODE_ENV=development
    depends_on:
      - backend
    command: npx ng serve --host 0.0.0.0 --port 4200 --proxy-config proxy.conf.json
    networks:
      - aitema-hinweis

  # ============================================================
  # Redis (Session Store + Cache + PubSub)
  # ============================================================
  redis:
    image: redis:7-alpine
    container_name: aitema-hinweis-redis
    ports:
      - "6380:6379"
    volumes:
      - redis-data:/data
    command: >
      redis-server
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - aitema-hinweis

  # ============================================================
  # Nginx Reverse Proxy
  # ============================================================
  nginx:
    image: nginx:1.27-alpine
    container_name: aitema-hinweis-nginx
    ports:
      - "8080:80"
      - "8443:443"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - backend
      - frontend
    networks:
      - aitema-hinweis

  # ============================================================
  # Tor Hidden Service - Anonymer Meldekanal (ยง13 HinSchG)
  # ============================================================
  tor:
    image: torproject/tor:latest
    container_name: aitema-hinweis-tor
    restart: unless-stopped
    volumes:
      - ./docker/tor/torrc:/etc/tor/torrc:ro
      - tor-data:/var/lib/tor
    depends_on:
      - nginx
    profiles:
      - tor
    networks:
      - aitema-hinweis
    # Tor laeuft als unprivilegierter User
    user: '100:101'
    read_only: true
    tmpfs:
      - /tmp

volumes:
  gl-data:
    driver: local
  redis-data:
    driver: local
  tor-data:
    driver: local

networks:
  aitema-hinweis:
    driver: bridge
    name: aitema-hinweis-network
